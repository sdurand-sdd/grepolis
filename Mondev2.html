<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grepolis FR39 - Cartes des Océans</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect } = React;

    const GrepolisOceans = () => {
        const [loading, setLoading] = useState(false);
        const [cities, setCities] = useState([]);
        const [alliances, setAlliances] = useState({});
        const [players, setPlayers] = useState({});
        const [selectedAlliance, setSelectedAlliance] = useState('all');
        const [search, setSearch] = useState('');
        const [hoveredCity, setHoveredCity] = useState(null);
        const [selectedCity, setSelectedCity] = useState(null);
        const [filesLoaded, setFilesLoaded] = useState({
            alliances: false,
            players: false,
            towns: false
        });
        const [customColors, setCustomColors] = useState({});
        const [hiddenAlliances, setHiddenAlliances] = useState(new Set());
        const [selectedOcean, setSelectedOcean] = useState('25');
        const [viewMode, setViewMode] = useState('ocean');
        const [lastUpdate, setLastUpdate] = useState(null);
        const [autoRefresh, setAutoRefresh] = useState(false);

        // Configuration GitHub
        const GITHUB_USER = 'sdurand-SDD';
        const GITHUB_REPO = 'grepolis';
        const GITHUB_BRANCH = 'main'; // ou 'master'
        
        // URLs des fichiers sur GitHub (format brut)
        const GITHUB_URLS = {
             alliances: 'https://sdurand-sdd.github.io/grepolis/alliances.txt',
                players: 'https://sdurand-sdd.github.io/grepolis/players.txt',
                towns: 'https://sdurand-sdd.github.io/grepolis/towns.txt'
        };

        // Fonction pour charger un fichier depuis GitHub
        const loadFileFromGitHub = async (fileType) => {
            setLoading(true);
            try {
                const response = await fetch(GITHUB_URLS[fileType]);
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                
                if (fileType === 'alliances') {
                    const alliancesData = {};
                    text.split('\n').forEach(line => {
                        if (line.trim()) {
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                alliancesData[parts[0]] = {
                                    id: parts[0],
                                    name: parts[1],
                                    points: parts[2] || '0',
                                    towns: parts[3] || '0',
                                    members: parts[4] || '0',
                                    rank: parts[5] || '0'
                                };
                            }
                        }
                    });
                    setAlliances(alliancesData);
                    setFilesLoaded(prev => ({ ...prev, alliances: true }));
                }

                if (fileType === 'players') {
                    const playersData = {};
                    text.split('\n').forEach(line => {
                        if (line.trim()) {
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                playersData[parts[0]] = {
                                    id: parts[0],
                                    name: parts[1],
                                    alliance_id: parts[2] || null,
                                    points: parts[3] || '0',
                                    rank: parts[4] || '0',
                                    towns: parts[5] || '0'
                                };
                            }
                        }
                    });
                    setPlayers(playersData);
                    setFilesLoaded(prev => ({ ...prev, players: true }));
                }

                if (fileType === 'towns') {
                    const townsData = [];
                    text.split('\n').forEach(line => {
                        if (line.trim()) {
                            const parts = line.split(',');
                            if (parts.length >= 7) {
                                const x = parseInt(parts[3]);
                                const y = parseInt(parts[4]);
                                
                                const oceanX = Math.floor(x / 100);
                                const oceanY = Math.floor(y / 100);
                                const ocean = oceanX * 10 + oceanY;
                                
                                townsData.push({
                                    id: parts[0],
                                    player_id: parts[1],
                                    name: parts[2],
                                    x: x,
                                    y: y,
                                    island: parts[5],
                                    points: parts[6],
                                    ocean: ocean.toString().padStart(2, '0')
                                });
                            }
                        }
                    });
                    
                    const enrichedTowns = townsData.map(town => {
                        const player = players[town.player_id];
                        const allianceId = player?.alliance_id;
                        return {
                            ...town,
                            player_name: player?.name || 'Inconnu',
                            alliance_id: allianceId,
                            alliance_name: allianceId && alliances[allianceId] ? alliances[allianceId].name : 'Sans alliance'
                        };
                    });

                    setCities(enrichedTowns);
                    setFilesLoaded(prev => ({ ...prev, towns: true }));
                }

                // Mettre à jour la date de dernière modification
                const now = new Date();
                setLastUpdate(now);
                localStorage.setItem('grepolis_last_update', now.toISOString());
                
            } catch (error) {
                console.error(`Erreur lors du chargement de ${fileType}:`, error);
                alert(`Erreur lors du chargement de ${fileType}. Vérifiez l'URL GitHub.`);
            } finally {
                setLoading(false);
            }
        };

        // Fonction pour charger tous les fichiers
        const loadAllFiles = async () => {
            setLoading(true);
            try {
                // Charger dans l'ordre: alliances -> players -> towns
                await loadFileFromGitHub('alliances');
                await loadFileFromGitHub('players');
                await loadFileFromGitHub('towns');
            } catch (error) {
                console.error('Erreur lors du chargement des fichiers:', error);
            } finally {
                setLoading(false);
            }
        };

        // Fonction pour vérifier la date de dernière modification sur GitHub
        const checkLastUpdateFromGitHub = async () => {
            try {
                // Utiliser l'API GitHub pour obtenir les infos du dernier commit
                const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/commits?path=Towns.txt&per_page=1`;
                const response = await fetch(apiUrl);
                
                if (response.ok) {
                    const commits = await response.json();
                    if (commits.length > 0) {
                        const lastCommitDate = new Date(commits[0].commit.committer.date);
                        setLastUpdate(lastCommitDate);
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la vérification de la date:', error);
            }
        };

        // Charger automatiquement au démarrage
        useEffect(() => {
            // Vérifier si des données sont déjà en cache
            const cachedData = localStorage.getItem('grepolis_cached_data');
            const lastUpdateStr = localStorage.getItem('grepolis_last_update');
            
            if (cachedData && lastUpdateStr) {
                const lastUpdateDate = new Date(lastUpdateStr);
                const now = new Date();
                const hoursDiff = (now - lastUpdateDate) / (1000 * 60 * 60);
                
                // Si les données ont moins de 1 heure, les utiliser
                if (hoursDiff < 1) {
                    const data = JSON.parse(cachedData);
                    setAlliances(data.alliances || {});
                    setPlayers(data.players || {});
                    setCities(data.cities || []);
                    setFilesLoaded({
                        alliances: !!data.alliances,
                        players: !!data.players,
                        towns: !!data.cities
                    });
                    setLastUpdate(lastUpdateDate);
                    return;
                }
            }
            
            // Sinon, charger depuis GitHub
            loadAllFiles();
            
            // Vérifier la date sur GitHub
            checkLastUpdateFromGitHub();
        }, []);

        // Sauvegarder en cache quand les données changent
        useEffect(() => {
            if (filesLoaded.alliances && filesLoaded.players && filesLoaded.towns) {
                const cacheData = {
                    alliances,
                    players,
                    cities
                };
                localStorage.setItem('grepolis_cached_data', JSON.stringify(cacheData));
            }
        }, [alliances, players, cities]);

        // Auto-refresh
        useEffect(() => {
            let interval;
            if (autoRefresh) {
                interval = setInterval(() => {
                    loadAllFiles();
                }, 300000); // 5 minutes
            }
            return () => clearInterval(interval);
        }, [autoRefresh]);

        // ... (le reste de votre code reste inchangé jusqu'à la partie affichage)

        const allFilesLoaded = filesLoaded.alliances && filesLoaded.players && filesLoaded.towns;

        // MODIFIEZ L'ÉCRAN D'ACCUEIL
        if (!allFilesLoaded || cities.length === 0) {
            return (
                <div className="w-full h-screen bg-slate-900 flex items-center justify-center p-8">
                    <div className="max-w-2xl w-full bg-slate-800 rounded-lg p-8 shadow-xl">
                        <h1 className="text-3xl font-bold text-amber-400 mb-6 text-center">
                            Grepolis FR39 - Cartes des Océans
                        </h1>
                        
                        <div className="space-y-6">
                            <div className="text-slate-300 mb-4">
                                <p className="mb-2">Les données sont chargées automatiquement depuis GitHub :</p>
                                <a 
                                    href={`https://github.com/${GITHUB_USER}/${GITHUB_REPO}`} 
                                    target="_blank" 
                                    className="text-blue-400 hover:text-blue-300"
                                >
                                    https://github.com/{GITHUB_USER}/{GITHUB_REPO}
                                </a>
                            </div>

                            <div className="space-y-4">
                                <div className="border-2 border-dashed border-slate-600 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-white font-medium">1. Alliances.txt</span>
                                        {filesLoaded.alliances && <span className="text-green-400">✓ Chargé</span>}
                                    </div>
                                    <div className="text-sm text-slate-400">
                                        Source: {GITHUB_URLS.alliances}
                                    </div>
                                </div>

                                <div className="border-2 border-dashed border-slate-600 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-white font-medium">2. Players.txt</span>
                                        {filesLoaded.players && <span className="text-green-400">✓ Chargé</span>}
                                    </div>
                                    <div className="text-sm text-slate-400">
                                        Source: {GITHUB_URLS.players}
                                    </div>
                                </div>

                                <div className="border-2 border-dashed border-slate-600 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-white font-medium">3. Towns.txt</span>
                                        {filesLoaded.towns && <span className="text-green-400">✓ Chargé</span>}
                                    </div>
                                    <div className="text-sm text-slate-400">
                                        Source: {GITHUB_URLS.towns}
                                    </div>
                                </div>
                            </div>

                            {loading ? (
                                <div className="text-center">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-400 mx-auto"></div>
                                    <p className="text-slate-300 mt-4">Chargement depuis GitHub...</p>
                                </div>
                            ) : (
                                <div className="flex gap-4">
                                    <button
                                        onClick={loadAllFiles}
                                        className="flex-1 px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition-colors"
                                    >
                                        Charger les données
                                    </button>
                                    <button
                                        onClick={() => {
                                            localStorage.removeItem('grepolis_cached_data');
                                            localStorage.removeItem('grepolis_last_update');
                                            window.location.reload();
                                        }}
                                        className="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg transition-colors"
                                    >
                                        Effacer le cache
                                    </button>
                                </div>
                            )}

                            {lastUpdate && (
                                <div className="bg-slate-700 p-4 rounded-lg">
                                    <h3 className="text-amber-300 font-semibold mb-2">Dernière mise à jour :</h3>
                                    <p className="text-slate-300">
                                        {lastUpdate.toLocaleDateString('fr-FR')} à {lastUpdate.toLocaleTimeString('fr-FR')}
                                    </p>
                                    <p className="text-slate-400 text-sm mt-2">
                                        Les données sont mises en cache localement pendant 1 heure
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // AJOUTER LA DATE DANS LE HEADER PRINCIPAL
        return (
            <div className="w-full h-screen bg-slate-900 flex flex-col">
                <div className="bg-slate-800 p-4 shadow-lg">
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-amber-400 flex items-center gap-2">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                                Grepolis FR39 - Océan {selectedOcean}
                            </h1>
                            {lastUpdate && (
                                <div className="text-sm text-slate-400 mt-1">
                                    Dernière mise à jour: {lastUpdate.toLocaleDateString('fr-FR')} {lastUpdate.toLocaleTimeString('fr-FR')}
                                </div>
                            )}
                        </div>
                        
                        <div className="flex gap-2 items-center">
                            <div className="flex items-center gap-2 mr-4">
                                <input
                                    type="checkbox"
                                    id="auto-refresh"
                                    checked={autoRefresh}
                                    onChange={(e) => setAutoRefresh(e.target.checked)}
                                    className="w-4 h-4 rounded"
                                />
                                <label htmlFor="auto-refresh" className="text-sm text-slate-300">
                                    Auto-refresh (5 min)
                                </label>
                            </div>
                            
                            <button
                                onClick={loadAllFiles}
                                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors"
                            >
                                Actualiser
                            </button>
                            
                            <select
                                value={selectedOcean}
                                onChange={(e) => setSelectedOcean(e.target.value)}
                                className="px-4 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-amber-400 focus:outline-none"
                            >
                                {availableOceans.map(ocean => (
                                    <option key={ocean} value={ocean}>
                                        Océan {ocean} ({oceanStats[ocean]?.totalCities || 0} villes)
                                    </option>
                                ))}
                            </select>
                            
                            <button
                                onClick={() => setViewMode(viewMode === 'ocean' ? 'world' : 'ocean')}
                                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                            >
                                {viewMode === 'ocean' ? 'Vue Monde' : 'Vue Océan'}
                            </button>
                        </div>
                    </div>
                    
                    {/* ... (le reste de votre code d'affichage reste inchangé) */}
                </div>
                
                {/* ... (le reste de votre code d'affichage reste inchangé) */}
            </div>
        );
    };

    ReactDOM.render(<GrepolisOceans />, document.getElementById('root'));
</script>
</body>
</html>