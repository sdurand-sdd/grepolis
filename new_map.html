<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grepolis - Focus Océan 24 (Image)</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background-color: #020617; color: white; font-family: sans-serif; overflow: hidden; }
        .grid-label { font-size: 1px; fill: #94a3b8; font-weight: bold; pointer-events: none; text-shadow: 0px 0px 2px black; }
        /* .ocean-bg { fill: #0f172a; }  <-- SUPPRIMÉ CAR INUTILE AVEC L'IMAGE */
        .subdivision-line { stroke: rgba(255, 255, 255, 0.3); stroke-width: 0.08; pointer-events: none; } /* Lignes un peu plus claires pour contraster avec l'image */
        .city-marker { 
            fill: #22c55e; 
            stroke: white; 
            stroke-width: 0.15; 
            transition: all 0.2s;
            cursor: pointer;
        }
        .city-marker:hover { 
            fill: #fbbf24; 
            r: 1.2; 
        }
        .tooltip-bg { fill: rgba(15, 23, 42, 0.9); stroke: #fbbf24; stroke-width: 0.2; }
        .tooltip-text { font-size: 1.5px; fill: white; font-weight: bold; }
        .tooltip-sub { font-size: 1.2px; fill: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Ocean24Map = () => {
            const [towns, setTowns] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [loading, setLoading] = useState(true);
            const [hoveredTown, setHoveredTown] = useState(null);

            const minX = 200, maxX = 299;
            const minY = 400, maxY = 499;

            // --- FONCTION DE DECODAGE DES ACCENTS ---
            const decodeGrepolisName = (str) => {
                if (!str) return "";
                try {
                    // Remplace les + par des espaces, puis décode l'URL
                    return decodeURIComponent(str.replace(/\+/g, ' '));
                } catch (e) {
                    return str; // Retourne le texte brut en cas d'erreur
                }
            };

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const [pRes, tRes] = await Promise.all([
                            fetch('./players.txt').then(r => r.text()),
                            fetch('./towns.txt').then(r => r.text())
                        ]);

                        const pData = {};
                        pRes.split('\n').forEach(line => {
                            const p = line.split(',');
                            if (p.length >= 2) {
                                // On décode le nom du joueur ici
                                pData[p[0]] = decodeGrepolisName(p[1]);
                            }
                        });

                        const tData = [];
                        tRes.split('\n').forEach(line => {
                            const p = line.split(',');
                            if (p.length >= 5) {
                                const x = parseInt(p[3]);
                                const y = parseInt(p[4]);
                                if (x >= minX && x <= maxX && y >= minY && y <= maxY) {
                                    tData.push({
                                        id: p[0],
                                        player_name: pData[p[1]] || "Inconnu",
                                        // On décode le nom de la ville ici
                                        name: decodeGrepolisName(p[2]),
                                        x: x,
                                        y: y,
                                        points: p[6]
                                    });
                                }
                            }
                        });
                        setTowns(tData);
                    } catch (err) { console.error(err); }
                    finally { setLoading(false); }
                };
                fetchData();
            }, []);
            const filteredTowns = useMemo(() => {
                if (!searchTerm || searchTerm.length < 2) return [];
                return towns.filter(t => t.player_name.toLowerCase().includes(searchTerm.toLowerCase()));
            }, [searchTerm, towns]);

            const gridElements = useMemo(() => {
                const elements = [];
                for (let i = 0; i <= 100; i += 10) {
                    elements.push(<line key={`v-${i}`} x1={minX+i} y1={minY} x2={minX+i} y2={maxY+1} className="subdivision-line" />);
                    elements.push(<line key={`h-${i}`} x1={minX} y1={minY+i} x2={maxX+1} y2={minY+i} className="subdivision-line" />);
                }
                for (let ix = 0; ix <= 100; ix += 10) {
                    for (let iy = 0; iy <= 100; iy += 10) {
                        // Ajout d'une petite ombre portée au texte pour qu'il reste lisible sur une image
                        elements.push(<text key={`l-${ix}-${iy}`} x={minX+ix+0.5} y={minY+iy+1.2} className="grid-label">{minX+ix},{minY+iy}</text>);
                    }
                }
                return elements;
            }, []);

            if (loading) return <div className="h-screen flex items-center justify-center">Chargement Océan 24...</div>;

            return (
                <div className="flex flex-col h-screen">
                    <div className="p-4 bg-slate-900 border-b border-slate-800 flex items-center justify-between z-10 relative">
                        <div>
                            <h1 className="text-xl font-bold text-amber-500">Océan 24</h1>
                            <p className="text-xs text-slate-500">Fond : Image locale | Filtrage par joueur</p>
                        </div>
                        <input 
                            type="text" 
                            placeholder="Nom du joueur..." 
                            className="bg-slate-800 border border-slate-700 px-4 py-2 rounded-lg w-64 focus:border-amber-500 outline-none text-sm"
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    <div className="flex-1 bg-black relative">
                        {/* ViewBox ajusté pour éviter les bords coupés */}
                        <svg viewBox={`${minX} ${minY} 100 100`} className="w-full h-full">
                            
                            {/* --- REMPLACEMENT DU FOND --- */}
                            {/* Ancienne ligne (rectangle bleu) :
                            <rect x={minX} y={minY} width="100" height="100" className="ocean-bg" /> 
                            */}
                            
                            {/* Nouvelle ligne (Image de fond) : */}
                            {/* Assurez-vous que le fichier s'appelle exactement ainsi et est dans le même dossier */}
                            <image 
                                href="./fond_ocean24.jpg" 
                                x={minX} 
                                y={minY} 
                                width="100" 
                                height="100" 
                                preserveAspectRatio="none" // Force l'image à remplir exactement le carré 100x100
                            />
                            {/* --------------------------- */}

                            {gridElements}

                            {filteredTowns.map(town => (
                                <g key={town.id} 
                                   onMouseEnter={() => setHoveredTown(town)}
                                   onMouseLeave={() => setHoveredTown(null)}>
                                    {/* Ajout d'une petite ombre noire sous le point vert pour qu'il ressorte sur l'image */}
                                    <circle cx={town.x} cy={town.y} r="0.8" fill="black" opacity="0.5" />
                                    <circle cx={town.x} cy={town.y} r="0.7" className="city-marker" />
                                    
                                    {hoveredTown?.id === town.id && (
                                        <g pointerEvents="none" style={{zIndex: 50}}>
                                            <rect 
                                                x={town.x + 1.5} y={town.y - 4} 
                                                width="15" height="5" rx="0.5"
                                                className="tooltip-bg"
                                            />
                                            <text x={town.x + 2} y={town.y - 2.2} className="tooltip-text">
                                                {town.name}
                                            </text>
                                            <text x={town.x + 2} y={town.y - 0.8} className="tooltip-sub">
                                                {town.player_name} ({town.points} pts)
                                            </text>
                                        </g>
                                    )}
                                </g>
                            ))}
                        </svg>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Ocean24Map />, document.getElementById('root'));
    </script>
</body>
</html>
